{% extends 'base.html' %}
{% load static %}

{% block title %}{{ story_user.username }}의 스토리 - Pirostagram{% endblock %}

{% block extra_css %}
<style>
    /* 기본 레이아웃 숨기기 */
    .sidebar {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
    }
    
    body {
        background: black;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
    
    .story-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .story-content {
        position: relative;
        max-width: 500px;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    .story-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 16px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
    }
    
    .progress-bars {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
    }
    
    .progress-bar-item {
        flex: 1;
        height: 3px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: white;
        width: 0%;
    }
    
    .progress-fill.active {
        animation: progress 5s linear forwards;
    }
    
    @keyframes progress {
        from { width: 0%; }
        to { width: 100%; }
    }
    
    .story-user-info {
        display: flex;
        align-items: center;
        color: white;
    }
    
    .story-user-info img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 8px;
        object-fit: cover;
    }
    
    .story-username {
        font-weight: 600;
    }
    
    .story-time {
        font-size: 12px;
        opacity: 0.8;
        margin-left: 8px;
    }
    
    .story-image {
        width: 100%;
        height: 100vh;
        object-fit: contain;
    }
    
    .story-nav {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40%;
        cursor: pointer;
        z-index: 5;
    }
    
    .story-nav.prev {
        left: 0;
    }
    
    .story-nav.next {
        right: 0;
    }
    
    .story-close {
        position: absolute;
        top: 16px;
        right: 16px;
        color: white;
        font-size: 32px;
        text-decoration: none;
        z-index: 20;
        cursor: pointer;
        background: rgba(0,0,0,0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="story-container">
    <div class="story-content">
        <!-- 헤더 -->
        <div class="story-header">
            <!-- 진행 바 -->
            <div class="progress-bars">
                {% for image in images %}
                <div class="progress-bar-item">
                    <div class="progress-fill"></div>
                </div>
                {% endfor %}
            </div>
            
            <!-- 유저 정보 -->
            <div class="story-user-info">
                {% if story_user.profile_image %}
                <img src="{{ story_user.profile_image.url }}" alt="{{ story_user.username }}">
                {% else %}
                <div style="width: 32px; height: 32px; border-radius: 50%; background: #666; margin-right: 8px;"></div>
                {% endif %}
                <span class="story-username">{{ story_user.username }}</span>
                <span class="story-time">{{ total_stories }}개의 스토리</span>
            </div>
        </div>
        
        <!-- 이미지 -->
        <img src="" alt="Story" class="story-image" id="story-image">
        
        <!-- 네비게이션 -->
        <div class="story-nav prev" id="prev-btn"></div>
        <div class="story-nav next" id="next-btn"></div>
        
        <!-- 닫기 버튼 -->
        <a href="{% url 'posts:feed' %}" class="story-close">×</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 이미지 데이터
const images = [
    {% for image in images %}
    "{{ image.url }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
];

console.log('Total images (stories):', images.length);

$(document).ready(function() {
    let currentIndex = 0;
    const totalImages = images.length;
    const imageElement = $('#story-image');
    const progressBars = $('.progress-fill');
    let autoPlayTimer;
    
    // 이미지 변경 함수
    function changeImage(index) {
        console.log('Changing to story index:', index);
        
        // 타이머 초기화
        if (autoPlayTimer) {
            clearTimeout(autoPlayTimer);
        }
        
        if (index < 0 || index >= totalImages) {
            // 스토리 끝나면 피드로 이동
            console.log('All stories finished, redirecting...');
            window.location.href = "{% url 'posts:feed' %}";
            return;
        }
        
        currentIndex = index;
        
        // 이미지 설정
        imageElement.attr('src', images[currentIndex]);
        console.log('Story image set to:', images[currentIndex]);
        
        // 진행 바 업데이트
        progressBars.each(function(i) {
            const bar = $(this);
            bar.removeClass('active');
            bar.css('width', '0%');
            
            if (i < currentIndex) {
                bar.css('width', '100%');
            } else if (i === currentIndex) {
                bar.addClass('active');
            }
        });
        
        // 5초 후 자동으로 다음 스토리
        autoPlayTimer = setTimeout(function() {
            console.log('Auto advancing to next story');
            changeImage(currentIndex + 1);
        }, 5000);
    }
    
    // 이전 버튼
    $('#prev-btn').click(function() {
        console.log('Previous button clicked');
        changeImage(currentIndex - 1);
    });
    
    // 다음 버튼
    $('#next-btn').click(function() {
        console.log('Next button clicked');
        changeImage(currentIndex + 1);
    });
    
    // 키보드 네비게이션
    $(document).keydown(function(e) {
        if (e.key === 'ArrowLeft') {
            changeImage(currentIndex - 1);
        } else if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault();
            changeImage(currentIndex + 1);
        } else if (e.key === 'Escape') {
            window.location.href = "{% url 'posts:feed' %}";
        }
    });
    
    // 첫 스토리 시작
    if (totalImages > 0) {
        console.log('Starting first story');
        changeImage(0);
    } else {
        console.error('No stories found!');
    }
});
</script>
{% endblock %}