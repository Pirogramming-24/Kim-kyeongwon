{% extends 'base.html' %}
{% block head %}
<title>post_update</title>
<style>
  main {
    height: 100vh;
    padding: 40px;
  }

  #ocrStatus {
    margin-top: 8px;
    font-size: 0.9rem;
    color: #666;
  }
</style>
{% endblock %}

{% block content %}
<form action="{% url 'posts:update' post.id %}" method="POST" enctype="multipart/form-data">
  {% csrf_token %}

  <h3>게시글 정보</h3>
  {{ post_form.as_p }}

  <p>
    영양 성분 이미지:
    <input type="file" id="nutritionImage" accept="image/*">
    <div id="ocrStatus"></div>
  </p>

  {{ nutrition_form.as_p }}

  <button class="btn btn-primary">수정 완료</button>
</form>

<script>
let ocrInProgress = false;

const fileInput = document.getElementById("nutritionImage");
const caloriesEl = document.getElementById("id_calories_kcal");
const carbsEl = document.getElementById("id_carbs_g");
const proteinEl = document.getElementById("id_protein_g");
const fatEl = document.getElementById("id_fat_g");
const ocrStatus = document.getElementById("ocrStatus");

function getCsrfToken() {
  const name = "csrftoken=";
  const cookies = document.cookie.split(";").map(v => v.trim());
  for (const c of cookies) if (c.startsWith(name)) return c.slice(name.length);
  return "";
}

function setAnalyzingUI(on, msg = "") {
  ocrStatus.textContent = on ? "영양 성분 분석 중입니다..." : msg;
  [caloriesEl, carbsEl, proteinEl, fatEl].forEach(el => {
    el.placeholder = on ? "분석 중..." : "";
    el.disabled = on;
    if (on) el.value = "";
  });
}

fileInput.addEventListener("change", async () => {
  if (ocrInProgress) return;

  const file = fileInput.files[0];
  if (!file) return;

  ocrInProgress = true;
  setAnalyzingUI(true);

  const fd = new FormData();
  fd.append("nutrition_image", file);

  try {
    const res = await fetch("{% url 'posts:ocr_preview' %}", {
      method: "POST",
      headers: { "X-CSRFToken": getCsrfToken() },
      body: fd
    });

    const data = await res.json();
    if (!data.ok) throw data.error;

    const n = data.nutrition || {};
    caloriesEl.value = n.calories_kcal ?? "";
    carbsEl.value = n.carbs_g ?? "";
    proteinEl.value = n.protein_g ?? "";
    fatEl.value = n.fat_g ?? "";

    if (n.calories_kcal == null) caloriesEl.placeholder = "확인 필요";
    if (n.carbs_g == null) carbsEl.placeholder = "확인 필요";
    if (n.protein_g == null) proteinEl.placeholder = "확인 필요";
    if (n.fat_g == null) fatEl.placeholder = "확인 필요";

    setAnalyzingUI(false, "분석 완료 (수정 가능)");

  } catch (e) {
    setAnalyzingUI(false, "분석 실패 (직접 입력)");
    alert("OCR 실패: " + e);
  } finally {
    ocrInProgress = false;
    [caloriesEl, carbsEl, proteinEl, fatEl].forEach(el => el.disabled = false);
  }
});
</script>
{% endblock %}